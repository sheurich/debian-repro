# .github/workflows/test.yml
# Run BATS test suite for shell scripts

name: Tests

on:
  push:
    branches: ['**']
    paths:
      - 'scripts/**'
      - 'tests/**'
      - '.github/workflows/test.yml'
  pull_request:
    branches: ['**']
    paths:
      - 'scripts/**'
      - 'tests/**'
  workflow_dispatch:

jobs:
  test:
    name: BATS Tests
    runs-on: ubuntu-latest
    env:
      TERM: linux

    steps:
      - name: Checkout repository
        uses: actions/checkout@08eba0b27e820071cde6df949e0beb9ba4906955  # v4.3.0

      - name: Setup BATS
        uses: bats-core/bats-action@2.0.0

      - name: Install dependencies
        run: |
          sudo apt-get update -qq
          sudo apt-get install -y -qq jq bc

      - name: Run unit tests
        run: |
          bats --formatter tap --print-output-on-failure tests/unit/
        continue-on-error: false

      - name: Run integration tests
        run: |
          bats --formatter tap --print-output-on-failure tests/integration/
        continue-on-error: false

      - name: Generate test report
        if: always()
        run: |
          {
            echo "## Test Results"
            echo ""
          } >> "$GITHUB_STEP_SUMMARY"

          if bats --formatter tap tests/unit/ tests/integration/ > test-results.tap 2>&1; then
            test_count=$(grep -c "^ok" test-results.tap || echo "0")
            echo "✅ All $test_count tests passed!" >> "$GITHUB_STEP_SUMMARY"
          else
            failed_count=$(grep -c "^not ok" test-results.tap || echo "0")
            {
              echo "❌ $failed_count test(s) failed"
              echo ""
              echo "\`\`\`"
              grep "^not ok" test-results.tap || true
              echo "\`\`\`"
            } >> "$GITHUB_STEP_SUMMARY"
          fi
