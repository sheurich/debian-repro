# .github/workflows/reproducible-debian-build.yml
# Build Debian rootfs with identical SHA256 to official Docker Hub images
name: Reproducible Debian Build

on:
  workflow_dispatch:
    inputs:
      suites:
        description: 'Debian suites to build (space-separated)'
        required: true
        default: 'bookworm trixie'
        type: string
      architectures:
        description: 'Architectures to build (comma-separated)'
        required: true
        default: 'amd64,arm64'
        type: string
      verify_only:
        description: 'Only verify against official (no push)'
        required: true
        default: true
        type: boolean
      expected_serial:
        description: 'Expected serial (optional) - fails if official serial differs. Note: Serial comes from official Debian repository, not calendar date.'
        required: false
        type: string

  schedule:
    # Run weekly to verify reproducibility
    - cron: '0 0 * * 0'

env:
  # Using commit SHA with distro-info-data fix (post-0.16)
  # See: https://github.com/debuerreotype/debuerreotype/commit/e044a8f
  DEBUERREOTYPE_VERSION: 'e044a8f'
  TZ: 'UTC'

permissions:
  contents: read
  packages: write

jobs:
  fetch-official:
    name: Fetch Official Parameters
    runs-on: ubuntu-24.04
    outputs:
      serial: ${{ steps.params.outputs.serial }}
      epoch: ${{ steps.params.outputs.epoch }}
      timestamp: ${{ steps.params.outputs.timestamp }}
      snapshot_url: ${{ steps.params.outputs.snapshot_url }}
      matrix: ${{ steps.matrix.outputs.matrix }}

    steps:
      - name: Checkout docker-debian-artifacts
        uses: actions/checkout@08eba0b27e820071cde6df949e0beb9ba4906955  # v4.3.0
        with:
          repository: debuerreotype/docker-debian-artifacts
          ref: dist-amd64
          path: official-amd64

      - name: Extract official parameters
        id: params
        run: |
            cd official-amd64

            # The dist-* branches have flat structure with files at root
            # NOTE: Serial comes from official Debian repository, NOT from current date
            # Debian publishes new builds approximately weekly
            SERIAL=$(cat serial)
            EPOCH=$(cat debuerreotype-epoch)
            SNAPSHOT_URL="http://snapshot.debian.org/archive/debian/${SERIAL}T000000Z"

            echo "ðŸ“¦ Fetched OFFICIAL Debian serial from debuerreotype/docker-debian-artifacts"
            echo "   Serial: $SERIAL (from official Debian build, not calendar date)"

            # Output parameters
            {
              echo "serial=$SERIAL"
              echo "epoch=$EPOCH"
              echo "timestamp=@$EPOCH"
              echo "snapshot_url=$SNAPSHOT_URL"
            } >> "$GITHUB_OUTPUT"

            # Create summary
            {
              echo "### Official Build Parameters"
              echo "**Source**: debuerreotype/docker-debian-artifacts (official Debian repository)"
              echo ""
              echo "- **Serial**: $SERIAL"
              echo "- **Epoch**: $EPOCH"
              echo "- **Timestamp**: @$EPOCH"
              echo "- **Snapshot**: $SNAPSHOT_URL"
              echo ""
              echo "> â„¹ï¸ Serial comes from official Debian builds, not current date. Debian publishes new images approximately weekly."
            } >> "$GITHUB_STEP_SUMMARY"

      - name: Validate expected serial
        if: github.event.inputs.expected_serial != ''
        run: |
            EXPECTED="${{ github.event.inputs.expected_serial }}"
            ACTUAL="${{ steps.params.outputs.serial }}"

            echo "Validating serial expectation..."
            echo "  Expected: $EXPECTED"
            echo "  Actual (from official repo): $ACTUAL"

            if [ "$ACTUAL" != "$EXPECTED" ]; then
              {
                echo "## âŒ Serial Mismatch"
                echo ""
                echo "**Expected serial**: \`$EXPECTED\`"
                echo "**Official serial**: \`$ACTUAL\`"
                echo ""
                echo "### Why This Happened"
                echo ""
                echo "This system verifies **official Debian builds** from the \`debuerreotype/docker-debian-artifacts\` repository."
                echo ""
                echo "- The current official serial is **$ACTUAL** (last Debian image build)"
                echo "- You expected serial **$EXPECTED**"
                echo "- Debian publishes new builds approximately weekly"
                echo "- Serial dates reflect when Debian published the build, not the current calendar date"
                echo ""
                echo "### What To Do"
                echo ""
                echo "**Option 1**: Use the current official serial (\`$ACTUAL\`)"
                echo "\`\`\`bash"
                echo "gh workflow run reproducible-debian-build.yml"
                echo "\`\`\`"
                echo ""
                echo "**Option 2**: Wait for Debian to publish a new build"
                echo "- Monitor: https://github.com/debuerreotype/docker-debian-artifacts"
                echo "- Official builds appear approximately weekly"
                echo ""
                echo "**Option 3**: Build daily images (future feature)"
                echo "- For arbitrary date builds, use the daily build workflow (not yet implemented)"
                echo "- This workflow is specifically for supply chain verification of official images"
              } >> "$GITHUB_STEP_SUMMARY"

              echo ""
              echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
              echo "âŒ SERIAL MISMATCH"
              echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
              echo ""
              echo "Expected: $EXPECTED"
              echo "Official: $ACTUAL"
              echo ""
              echo "This system verifies OFFICIAL Debian builds."
              echo "The current official serial is $ACTUAL"
              echo "(from debuerreotype/docker-debian-artifacts)"
              echo ""
              echo "Debian publishes new builds approximately weekly."
              echo "Serial $EXPECTED is not yet available in the official repository."
              echo ""
              exit 1
            fi

            {
              echo "### âœ… Serial Validation Passed"
              echo ""
              echo "Expected serial \`$EXPECTED\` matches official serial."
            } >> "$GITHUB_STEP_SUMMARY"

      - name: Setup build matrix
        id: matrix
        run: |
            # Parse architectures input
            IFS=',' read -ra ARCHS <<< "${{ github.event.inputs.architectures || 'amd64,arm64' }}"

            # Create matrix JSON with proper architecture mappings
            MATRIX='{"include":['
            FIRST=true
            for arch in "${ARCHS[@]}"; do
              arch=$(echo "$arch" | xargs)  # trim whitespace

              # Map architecture names to runner, dpkg_arch, and artifacts branch
              case "$arch" in
                amd64)
                  runner="ubuntu-24.04"  # Native x86_64
                  dpkg_arch="amd64"
                  artifacts_branch="dist-amd64"
                  ;;
                arm64)
                  runner="ubuntu-24.04-arm"  # Native ARM64 - much faster!
                  dpkg_arch="arm64"
                  artifacts_branch="dist-arm64v8"
                  ;;
                armhf)
                  runner="ubuntu-24.04-arm"  # Native 32-bit ARM on ARM64
                  dpkg_arch="armhf"
                  artifacts_branch="dist-arm32v7"
                  ;;
                i386)
                  runner="ubuntu-24.04"  # Needs QEMU
                  dpkg_arch="i386"
                  artifacts_branch="dist-i386"
                  ;;
                ppc64el)
                  runner="ubuntu-24.04"  # Needs QEMU
                  dpkg_arch="ppc64le"
                  artifacts_branch="dist-ppc64le"
                  ;;
                s390x)
                  echo "Warning: s390x not yet available in artifacts repo"
                  continue
                  ;;
                *)
                  echo "Unknown architecture: $arch"
                  continue
                  ;;
              esac

              if [ "$FIRST" = true ]; then
                FIRST=false
              else
                MATRIX+=','
              fi

              MATRIX+="{\"arch\":\"$arch\",\"dpkg_arch\":\"$dpkg_arch\",\"runner\":\"$runner\",\"artifacts_branch\":\"$artifacts_branch\"}"
            done
            MATRIX+=']}'

            echo "matrix=$MATRIX" >> "$GITHUB_OUTPUT"

  build:
    name: Build ${{ matrix.arch }}
    needs: fetch-official
    runs-on: ${{ matrix.runner }}
    strategy:
      fail-fast: false
      matrix: ${{ fromJSON(needs.fetch-official.outputs.matrix) }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@08eba0b27e820071cde6df949e0beb9ba4906955  # v4.3.0

      - name: Checkout docker-debian-artifacts (${{ matrix.arch }})
        uses: actions/checkout@08eba0b27e820071cde6df949e0beb9ba4906955  # v4.3.0
        with:
          repository: debuerreotype/docker-debian-artifacts
          ref: ${{ matrix.artifacts_branch }}
          path: official-${{ matrix.arch }}

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@e468171a9de216ec08956ac3ada2f0791b6bd435  # v3.11.1

      - name: Set up QEMU
        # QEMU needed for cross-architecture builds:
        # - ubuntu-24.04 (x86_64): native amd64, needs QEMU for i386/ppc64el
        # - ubuntu-24.04-arm (arm64): native arm64/armhf (32-bit ARM runs on 64-bit ARM hardware)
        # Note: Docker requires QEMU for i386 on amd64 despite x86 backward compatibility
        if: (matrix.runner == 'ubuntu-24.04' && matrix.arch != 'amd64')
        uses: docker/setup-qemu-action@c7c53464625b32c7a7e944ae62b3e17d2b600130  # v3.7.0

      - name: Cache debuerreotype
        uses: actions/cache@0057852bfaa89a56745cba8c7296529d2fc39830  # v4.3.0
        with:
          path: ~/.cache/debuerreotype
          key: debuerreotype-${{ env.DEBUERREOTYPE_VERSION }}-${{ matrix.arch }}

      - name: Setup debuerreotype
        run: |
          set -Eeuo pipefail -x

          # Clone or update debuerreotype
          if [ ! -d ~/.cache/debuerreotype ]; then
            git clone https://github.com/debuerreotype/debuerreotype.git ~/.cache/debuerreotype
          fi

          cd ~/.cache/debuerreotype
          git fetch --tags origin
          # Support both tags (0.16) and commit SHAs (e044a8f)
          git checkout "${DEBUERREOTYPE_VERSION}"

          # Copy to workspace
          cp -r ~/.cache/debuerreotype ${{ github.workspace }}/debuerreotype

          # Verify version
          cd ${{ github.workspace }}/debuerreotype
          ./scripts/debuerreotype-version

      - name: Login to GitHub Container Registry
        if: github.event_name != 'pull_request'
        uses: docker/login-action@9780b0c442fbb1117ed29e0efdff1e18412f7567  # v3.3.0
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build debuerreotype Docker image
        run: |
          cd debuerreotype

          # Use buildx with registry cache for faster builds
          docker buildx build \
            --pull \
            --load \
            --cache-from type=registry,ref=ghcr.io/${{ github.repository }}/debuerreotype-cache:${{ matrix.arch }}-${{ env.DEBUERREOTYPE_VERSION }} \
            --cache-to type=registry,ref=ghcr.io/${{ github.repository }}/debuerreotype-cache:${{ matrix.arch }}-${{ env.DEBUERREOTYPE_VERSION }},mode=max \
            --tag debuerreotype:${{ env.DEBUERREOTYPE_VERSION }} \
            --platform linux/${{ matrix.arch }} \
            .

      - name: Build Debian rootfs
        run: |
          set -Eeuo pipefail -x

          EPOCH="${{ needs.fetch-official.outputs.epoch }}"
          SUITES="${{ github.event.inputs.suites || 'bookworm trixie' }}"

          mkdir -p output

          # Run debuerreotype (uses /opt/debuerreotype from Dockerfile)
          docker run \
            --rm \
            --cap-add SYS_ADMIN \
            --cap-drop SETFCAP \
            --security-opt seccomp=unconfined \
            --security-opt apparmor=unconfined \
            --tmpfs /tmp:dev,exec,suid,noatime \
            --env TZ=UTC \
            --env SOURCE_DATE_EPOCH="$EPOCH" \
            --env TMPDIR=/tmp \
            --volume "$PWD/output":/output \
            debuerreotype:${{ env.DEBUERREOTYPE_VERSION }} \
            sh -c "
              set -ex
              cd /tmp
              for suite in $SUITES; do
                echo \"Building \$suite for ${{ matrix.dpkg_arch }}...\"
                /opt/debuerreotype/examples/debian.sh \
                  --arch=\"${{ matrix.dpkg_arch }}\" \
                  /output \
                  \"\$suite\" \
                  \"@$EPOCH\"
              done
            "

      - name: Verify reproducibility
        id: verify
        run: |
          set -Eeuo pipefail

          SERIAL="${{ needs.fetch-official.outputs.serial }}"
          SUITES="${{ github.event.inputs.suites || 'bookworm trixie' }}"
          ARCH="${{ matrix.arch }}"
          DPKG_ARCH="${{ matrix.dpkg_arch }}"

          {
            echo "## Reproducibility Report ($ARCH)"
            echo ""
          } >> "$GITHUB_STEP_SUMMARY"

          FAILED=0
          for suite in $SUITES; do
            echo "### $suite" >> "$GITHUB_STEP_SUMMARY"

            # Our build
            OUR_FILE="output/$SERIAL/$DPKG_ARCH/$suite/rootfs.tar.xz"
            if [ ! -f "$OUR_FILE" ]; then
              echo "âŒ Build failed - file not found" >> "$GITHUB_STEP_SUMMARY"
              FAILED=1
              continue
            fi

            OUR_SHA256=$(sha256sum "$OUR_FILE" | cut -d' ' -f1)

            # Official checksum (flat structure: official-$ARCH/$suite/rootfs.tar.xz.sha256)
            OFFICIAL_FILE="official-$ARCH/$suite/rootfs.tar.xz.sha256"
            if [ -f "$OFFICIAL_FILE" ]; then
              OFFICIAL_SHA256=$(cut -d' ' -f1 < "$OFFICIAL_FILE")

              if [ "$OUR_SHA256" = "$OFFICIAL_SHA256" ]; then
                {
                  echo "âœ… **Reproducible!**"
                  echo "- SHA256: \`$OUR_SHA256\`"
                } >> "$GITHUB_STEP_SUMMARY"
              else
                {
                  echo "âŒ **Not reproducible**"
                  echo "- Official: \`$OFFICIAL_SHA256\`"
                  echo "- Ours: \`$OUR_SHA256\`"
                } >> "$GITHUB_STEP_SUMMARY"
                FAILED=1
              fi
            else
              {
                echo "âš ï¸ Official checksum not found"
                echo "- Our SHA256: \`$OUR_SHA256\`"
              } >> "$GITHUB_STEP_SUMMARY"
            fi

            echo "" >> "$GITHUB_STEP_SUMMARY"
          done

          if [ $FAILED -eq 0 ]; then
            echo "âœ… All builds reproducible" >> "$GITHUB_STEP_SUMMARY"
            echo "success=true" >> "$GITHUB_OUTPUT"
          else
            echo "âŒ Some builds not reproducible" >> "$GITHUB_STEP_SUMMARY"
            echo "success=false" >> "$GITHUB_OUTPUT"
            exit 1
          fi

      - name: Upload artifacts
        if: always()
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02  # v4.6.2
        with:
          name: debian-${{ matrix.arch }}-${{ needs.fetch-official.outputs.serial }}
          path: output/
          retention-days: 7

  summary:
    name: Final Summary
    needs: [fetch-official, build]
    runs-on: ubuntu-24.04
    if: always()

    steps:
      - name: Generate final report
        run: |
          {
            echo "# Debian Reproducible Build Report"
            echo ""
            echo "**Serial**: ${{ needs.fetch-official.outputs.serial }}"
            echo "**Debuerreotype**: ${{ env.DEBUERREOTYPE_VERSION }}"
            echo ""
          } >> "$GITHUB_STEP_SUMMARY"

          if [ "${{ needs.build.result }}" = "success" ]; then
            echo "## âœ… All builds are reproducible!" >> "$GITHUB_STEP_SUMMARY"
          else
            echo "## âŒ Some builds failed reproducibility check" >> "$GITHUB_STEP_SUMMARY"
          fi

  update-dashboard:
    name: Update Dashboard
    needs: [fetch-official, build]
    runs-on: ubuntu-24.04
    if: always() && github.event_name != 'pull_request'
    permissions:
      contents: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@08eba0b27e820071cde6df949e0beb9ba4906955  # v4.3.0

      - name: Download all artifacts
        uses: actions/download-artifact@fa0a91b85d4f404e444e00e005971372dc801d16  # v4.1.8
        with:
          path: artifacts/

      - name: Create results directory
        run: mkdir -p results

      - name: Checkout official artifacts for verification
        run: |
          set -Eeuo pipefail

          # Get list of architectures from inputs
          IFS=',' read -ra ARCHS <<< "${{ github.event.inputs.architectures || 'amd64,arm64' }}"

          for arch in "${ARCHS[@]}"; do
            arch=$(echo "$arch" | xargs)  # trim whitespace

            # Map architecture to artifacts branch
            case "$arch" in
              amd64) artifacts_branch="dist-amd64" ;;
              arm64) artifacts_branch="dist-arm64v8" ;;
              armhf) artifacts_branch="dist-arm32v7" ;;
              i386) artifacts_branch="dist-i386" ;;
              ppc64el) artifacts_branch="dist-ppc64le" ;;
              *) continue ;;
            esac

            echo "Cloning official artifacts for $arch (branch: $artifacts_branch)"
            git clone --depth 1 --branch "$artifacts_branch" \
              https://github.com/debuerreotype/docker-debian-artifacts.git \
              "official-$arch"
          done

      - name: Process build artifacts and generate JSON results
        run: |
          set -Eeuo pipefail

          SERIAL="${{ needs.fetch-official.outputs.serial }}"
          SUITES="${{ github.event.inputs.suites || 'bookworm trixie' }}"

          # Process each architecture artifact
          for artifact_dir in artifacts/debian-*; do
            if [ ! -d "$artifact_dir" ]; then continue; fi

            # Extract architecture from artifact name (format: debian-{arch}-{serial})
            artifact_name=$(basename "$artifact_dir")
            arch=$(echo "$artifact_name" | sed 's/^debian-//' | sed "s/-$SERIAL$//")

            echo "Processing architecture: $arch"

            # Get official checksums for this architecture
            official_dir="official-$arch"
            if [ ! -d "$official_dir" ]; then
              echo "Warning: No official checksums directory for $arch"
              continue
            fi

            # Process each suite
            for suite in $SUITES; do
              echo "  Processing suite: $suite"

              # Path to our build (use glob to find arch directory)
              shopt -s nullglob
              our_files=("$artifact_dir/$SERIAL/"*"/$suite/rootfs.tar.xz")
              shopt -u nullglob

              if [ ${#our_files[@]} -eq 0 ]; then
                echo "    Warning: Build file not found in $artifact_dir/$SERIAL/*/$suite/"
                # Create failed result
                jq -n \
                  --arg suite "$suite" \
                  '{
                    reproducible: false,
                    sha256: "build-failed",
                    build_time_seconds: 0,
                    error: "Build file not found"
                  }' > "results/${arch}-${suite}.json"
                continue
              fi

              our_file="${our_files[0]}"

              # Compute our SHA256
              our_sha256=$(sha256sum "$our_file" | cut -d' ' -f1)

              # Get official SHA256
              official_file="$official_dir/$suite/rootfs.tar.xz.sha256"
              if [ -f "$official_file" ]; then
                official_sha256=$(cut -d' ' -f1 < "$official_file")

                if [ "$our_sha256" = "$official_sha256" ]; then
                  echo "    âœ… Reproducible"
                  reproducible=true
                else
                  echo "    âŒ Not reproducible"
                  reproducible=false
                fi
              else
                echo "    âš ï¸ Official checksum not found"
                official_sha256="not-available"
                reproducible=false
              fi

              # Create JSON result file
              jq -n \
                --arg sha "$our_sha256" \
                --arg official "$official_sha256" \
                --argjson repro "$reproducible" \
                '{
                  reproducible: $repro,
                  sha256: $sha,
                  official_sha256: $official,
                  build_time_seconds: 0
                }' > "results/${arch}-${suite}.json"
            done
          done

          # List results for debugging
          echo "Generated result files:"
          ls -la results/

      - name: Capture environment
        run: |
          ./scripts/capture-environment.sh --output results/environment.json

      - name: Generate report
        run: |
          ./scripts/generate-report.sh \
            --results-dir results \
            --output report.json \
            --run-id "${{ github.run_id }}" \
            --serial "${{ needs.fetch-official.outputs.serial }}" \
            --epoch "${{ needs.fetch-official.outputs.epoch }}"

      - name: Update dashboard data
        run: |
          set -Eeuo pipefail

          # Copy to latest.json
          cp report.json dashboard/data/latest.json

          # Append to history (keep last 90 entries)
          jq -s '.[0] + [.[1]] | sort_by(.timestamp) | .[-90:]' \
            dashboard/data/history.json report.json > dashboard/data/history.tmp
          mv dashboard/data/history.tmp dashboard/data/history.json

          echo "Dashboard data updated successfully"

      - name: Generate data exports
        run: |
          ./scripts/generate-exports.sh \
            --report dashboard/data/latest.json \
            --output-dir dashboard/data

      - name: Generate badges
        run: |
          ./scripts/generate-badges.sh \
            --report report.json \
            --output-dir dashboard/badges

      - name: Commit and push dashboard updates
        id: push
        run: |
          set -Eeuo pipefail

          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          git add dashboard/data/ dashboard/badges/

          if git diff --staged --quiet; then
            echo "No changes to commit"
            echo "pushed=false" >> "$GITHUB_OUTPUT"
          else
            git commit -m "Update dashboard data from build ${{ github.run_id }}" -m "Serial: ${{ needs.fetch-official.outputs.serial }}" -m "Epoch: ${{ needs.fetch-official.outputs.epoch }}" -m "Run: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"

            # Pull and push with retry to handle concurrent commits
            # Dashboard files are generated fresh each run, so we can safely
            # overwrite with our version if there are conflicts
            max_attempts=5
            attempt=1
            pushed=false

            # Save our generated dashboard files
            if [ ! -d dashboard/data ] || [ ! -d dashboard/badges ]; then
              echo "Error: Dashboard directories don't exist before backup"
              exit 1
            fi
            cp -r dashboard/data /tmp/dashboard-data-backup
            cp -r dashboard/badges /tmp/dashboard-badges-backup

            while [ $attempt -le $max_attempts ] && [ "$pushed" = "false" ]; do
              echo "Push attempt $attempt of $max_attempts"

              # Try to push
              if git push origin main; then
                pushed=true
                echo "pushed=true" >> "$GITHUB_OUTPUT"
                echo "Push successful"
              else
                echo "Push rejected (remote has new commits), rebasing..."

                # Fetch latest and reset to it
                git fetch origin main
                git reset --hard origin/main

                # Restore our freshly generated dashboard files
                rm -rf dashboard/data dashboard/badges
                cp -r /tmp/dashboard-data-backup dashboard/data
                cp -r /tmp/dashboard-badges-backup dashboard/badges

                # Recommit our changes on top of latest
                git add dashboard/data/ dashboard/badges/
                if git diff --staged --quiet; then
                  echo "No changes after reset, another build pushed identical data"
                  pushed=true
                  echo "pushed=true" >> "$GITHUB_OUTPUT"
                else
                  git commit -m "Update dashboard data from build ${{ github.run_id }}" -m "Serial: ${{ needs.fetch-official.outputs.serial }}" -m "Epoch: ${{ needs.fetch-official.outputs.epoch }}" -m "Run: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
                  echo "Recommitted on top of latest remote"
                fi
              fi

              if [ "$pushed" = "false" ]; then
                attempt=$((attempt + 1))
                if [ $attempt -le $max_attempts ]; then
                  echo "Waiting before retry..."
                  sleep $((attempt * 2))
                fi
              fi
            done

            # Clean up backups
            rm -rf /tmp/dashboard-data-backup /tmp/dashboard-badges-backup

            if [ "$pushed" = "false" ]; then
              echo "Failed to push after $max_attempts attempts"
              exit 1
            fi
          fi
